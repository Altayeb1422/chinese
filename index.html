<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²‰æµ¸å¼ä¸­æ–‡å­¦ä¹ å¹³å° (å•æ–‡ä»¶å¢å¼ºç‰ˆ)</title>
    <!-- Include Three.js via CDN (Optional) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script> -->

    <style>
        /* --- ALL CSS from previous version --- */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5a623;
            --background-color: #f8f9fa;
            --content-background: rgba(255, 255, 255, 0.97);
            --text-color: #333;
            --light-gray: #e9ecef;
            --medium-gray: #ced4da;
            --dark-gray: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
        #threejs-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .app-container { max-width: 1100px; margin: 20px auto; padding: 0; background-color: var(--content-background); border-radius: var(--border-radius); box-shadow: var(--box-shadow); flex-grow: 1; z-index: 1; display: flex; flex-direction: column; overflow: hidden; }
        .main-nav { display: flex; justify-content: center; background-color: var(--primary-color); padding: 10px 0; border-radius: var(--border-radius) var(--border-radius) 0 0; }
        .main-nav button { background-color: transparent; border: none; color: white; text-decoration: none; padding: 12px 25px; margin: 0 5px; font-size: 16px; font-weight: 500; border-radius: 5px; transition: background-color 0.3s ease; cursor: pointer; }
        .main-nav button:hover, .main-nav button.active { background-color: rgba(255, 255, 255, 0.2); }
        #page-content { flex-grow: 1; padding: 25px 30px; }
        .module-content { display: none; animation: fadeIn 0.5s ease; }
        .module-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .module-content h2 { color: var(--primary-color); border-bottom: 2px solid var(--light-gray); padding-bottom: 10px; margin-bottom: 25px; margin-top: 0; }
        button { padding: 10px 20px; font-size: 16px; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s ease, box-shadow 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        button.primary { background-color: var(--primary-color); color: white; }
        button.primary:hover { background-color: #3a7ac8; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button:disabled { background-color: var(--medium-gray); cursor: not-allowed; box-shadow: none; color: #6c757d;}
        input[type="text"], textarea { padding: 12px; font-size: 16px; border: 1px solid var(--medium-gray); border-radius: var(--border-radius); width: 100%; box-sizing: border-box; }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); }
        .loading-indicator { text-align: center; padding: 30px; color: var(--dark-gray); font-style: italic; font-size: 1.1em; }
        .error-message { color: var(--danger-color); font-weight: bold; text-align: center; padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: var(--border-radius); margin-top: 15px; }
        .info-message { color: var(--info-color); padding: 15px; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: var(--border-radius); margin-top: 15px; }
        .hidden { display: none !important; }
        #lookup-input-area { display: flex; gap: 10px; margin-bottom: 20px; }
        #lookup-input { flex-grow: 1; }
        #lookup-result-container { margin-top: 20px; padding: 25px; background-color: #ffffff; border: 1px solid var(--light-gray); border-radius: var(--border-radius); min-height: 100px; }
        #lookup-result h3 { margin-top: 20px; margin-bottom: 10px; color: var(--primary-color); font-size: 1.15em; font-weight: 600; border-bottom: 1px solid var(--light-gray); padding-bottom: 5px; }
        #lookup-result h3:first-child { margin-top: 0; }
        #lookup-result ul { padding-left: 25px; margin-top: 8px; list-style: disc; }
        #lookup-result li { margin-bottom: 10px; line-height: 1.7; } /* Added line-height */
        #lookup-result p { margin-bottom: 12px; line-height: 1.7; }
        #lookup-result div > p { margin-bottom: 12px; line-height: 1.7; } /* Target paragraphs in æ·±å…¥ç†è§£ */
        #lookup-history { margin-top: 30px; }
        #history-list button { background: none; border: none; color: var(--primary-color); cursor: pointer; padding: 5px; font-size: 1em; }
        #history-list button:hover { text-decoration: underline; }
        #save-word-button { margin-top: 15px; background-color: var(--success-color); color: white; }
        #save-word-button:hover { background-color: #218838; }
        #quiz-container { background-color: #fff; padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--light-gray); }
        #quiz-area { margin-bottom: 20px; }
        .quiz-question { font-weight: bold; font-size: 1.2em; margin-bottom: 20px; }
        .quiz-options button { display: block; width: 100%; text-align: left; padding: 12px 18px; margin-bottom: 10px; background-color: var(--light-gray); border: 1px solid #ddd; }
        .quiz-options button:hover:not(:disabled) { background-color: #dcdcdc; }
        .quiz-options button.correct { background-color: #d4edda !important; border-color: #c3e6cb; font-weight: bold; color: #155724 !important; }
        .quiz-options button.incorrect { background-color: #f8d7da !important; border-color: #f5c6cb; color: #721c24 !important; }
        .quiz-feedback { margin-top: 20px; padding: 15px; border-radius: var(--border-radius); text-align: center; font-weight: bold; }
        .feedback-correct { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .feedback-incorrect { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        #quiz-controls { margin-top: 20px; display: flex; justify-content: center; gap: 20px; }
        #quiz-summary { margin-top: 20px; padding: 15px; background-color: var(--light-gray); border-radius: var(--border-radius); }
        #reading-container { }
        .reading-passage { background-color: #fff; padding: 25px; border: 1px solid var(--light-gray); border-radius: var(--border-radius); line-height: 1.8; font-size: 1.1em; margin-bottom: 20px; }
        .highlight { background-color: var(--secondary-color); color: white; padding: 0.1em 0.4em; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        .highlight:hover { background-color: #e0951a; }
        .reading-comprehension { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--light-gray); }
        #definition-popup { position: absolute; background: #333; color: white; border: 1px solid #555; padding: 10px 15px; border-radius: 5px; box-shadow: 0 3px 8px rgba(0,0,0,0.3); z-index: 100; max-width: 300px; font-size: 0.95em; }
        #progress-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-item { background-color: var(--light-gray); padding: 20px; border-radius: var(--border-radius); text-align: center; }
        .stat-item strong { display: block; font-size: 1.8em; color: var(--primary-color); margin-bottom: 8px; }
        .stat-item span { font-size: 1.1em; color: var(--dark-gray); }
        #improvement-suggestions { margin-top: 20px; padding: 20px; background-color: #e2f3ff; border: 1px solid #b8dffc; border-radius: var(--border-radius); }
        #progress-chart-container { margin-top: 30px; min-height: 150px; background-color: #fff; padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--light-gray); text-align: center; color: var(--dark-gray);}
        #settings-container { }
        .settings-group { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--light-gray); }
        .settings-group h3 { margin-top: 0; margin-bottom: 15px; color: var(--dark-gray); }
        .settings-group label { display: block; margin-bottom: 15px; font-weight: 500; }
        .settings-group select, .settings-group input[type="number"], .settings-group input[type="checkbox"] { margin-left: 10px; padding: 8px; border-radius: 5px; border: 1px solid var(--medium-gray); }
        #feedback-form textarea { height: 100px; margin-top: 10px; }
        #feedback-form button { margin-top: 10px; }
        footer { text-align: center; padding: 20px 30px; font-size: 0.9em; color: var(--dark-gray); border-top: 1px solid var(--light-gray); background-color: var(--content-background); border-radius: 0 0 var(--border-radius) var(--border-radius); }
        footer p { margin: 5px 0; }
        footer a { color: var(--primary-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        footer strong { color: var(--danger-color); }
        @media (max-width: 768px) { .app-container { margin: 10px; border-radius: 0; } .main-nav { flex-wrap: wrap; padding: 5px 0; border-radius: 0; } .main-nav button { padding: 10px 15px; font-size: 14px; margin: 3px; } #page-content { padding: 15px; } #lookup-input-area { flex-direction: column; gap: 10px; } #progress-stats { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- <div id="threejs-background"></div> -->

    <div class="app-container">
        <nav class="main-nav">
            <button data-target="lookup-section" class="nav-button active">é¦–é¡µ (æŸ¥è¯)</button>
            <button data-target="quiz-section" class="nav-button">è¯æ±‡æµ‹éªŒ</button>
            <button data-target="reading-section" class="nav-button">é˜…è¯»ä¸æ•…äº‹</button>
            <button data-target="progress-section" class="nav-button">å­¦ä¹ è¿›åº¦</button>
            <button data-target="settings-section" class="nav-button">è®¾ç½®</button>
        </nav>

        <main id="page-content">
            <!-- Word Lookup Module -->
            <section id="lookup-section" class="module-content active">
                <h2>æŸ¥è¯ä¸è§£é‡Š</h2>
                <div id="lookup-input-area">
                    <input type="text" id="lookup-input" placeholder="è¾“å…¥ä¸­æ–‡è¯è¯­æˆ–çŸ­è¯­...">
                    <button id="lookup-button" class="primary">æŸ¥è¯¢</button>
                </div>
                <div id="lookup-result-container" class="hidden"></div>
                <div id="lookup-history">
                    <h3>æŸ¥è¯¢å†å²</h3>
                    <ul id="history-list"><li>æš‚æ— æŸ¥è¯¢å†å²</li></ul>
                </div>
            </section>

            <!-- Quiz Module -->
            <section id="quiz-section" class="module-content">
                <h2>è¯æ±‡æµ‹éªŒ (SRS)</h2>
                <div id="quiz-container">
                    <div id="quiz-setup">
                        <p>å‡†å¤‡å¥½å¼€å§‹æµ‹éªŒäº†å—ï¼Ÿå°†æ ¹æ®æ‚¨çš„å­¦ä¹ åˆ—è¡¨å’Œå¤ä¹ è®¡åˆ’é€‰æ‹©é¢˜ç›®ã€‚</p>
                        <button id="start-quiz-button" class="primary">å¼€å§‹æµ‹éªŒ</button>
                    </div>
                    <div id="quiz-area" class="hidden">
                        <div id="quiz-question" class="quiz-question"></div>
                        <div id="quiz-options" class="quiz-options"></div>
                        <div id="quiz-feedback" class="quiz-feedback hidden"></div>
                    </div>
                    <div id="quiz-controls" class="hidden">
                        <button id="next-question-button" class="primary">ä¸‹ä¸€é¢˜</button>
                    </div>
                    <div id="quiz-summary" class="hidden">
                        <h3>æœ¬æ¬¡æµ‹éªŒæ€»ç»“</h3>
                        <p id="summary-text"></p>
                        <button id="quiz-done-button" class="primary">å®Œæˆ</button>
                    </div>
                </div>
            </section>

            <!-- Reading Module -->
            <section id="reading-section" class="module-content">
                 <h2>é˜…è¯»ä¸æ•…äº‹</h2>
                 <div id="reading-container">
                     <button id="generate-story-button" class="primary">ç”Ÿæˆæ–°æ•…äº‹ (åŸºäºå·²å­¦è¯æ±‡)</button>
                     <div id="reading-passage-area" style="margin-top: 20px;">
                         <p>è¯·ç‚¹å‡»æŒ‰é’®ç”Ÿæˆé˜…è¯»ææ–™ï¼Œæˆ–å…ˆå»â€œé¦–é¡µâ€å­¦ä¹ ä¸€äº›å•è¯ã€‚</p>
                         <!-- Reading passage will be loaded here -->
                     </div>
                     <!-- Comprehension Quiz Placeholder -->
                     <!-- <div id="reading-comprehension-area" class="reading-comprehension hidden"> ... </div> -->
                 </div>
                 <div id="definition-popup" class="hidden">Definition goes here</div>
            </section>

            <!-- Progress Tracking Module -->
            <section id="progress-section" class="module-content">
                 <h2>å­¦ä¹ è¿›åº¦</h2>
                 <div id="progress-stats">
                     <div class="stat-item"><strong>å·²å­¦å•è¯</strong><span id="stat-total-words">0</span></div>
                     <div class="stat-item"><strong>ä»Šæ—¥åˆ°æœŸå¤ä¹ </strong><span id="stat-today-reviews">0</span></div>
                     <div class="stat-item"><strong>ç»¼åˆå‡†ç¡®ç‡</strong><span id="stat-quiz-accuracy">N/A</span></div>
                     <div class="stat-item"><strong>å­¦ä¹ è¿èƒœ</strong><span id="stat-streak">0 å¤©</span></div>
                 </div>
                 <div id="progress-chart-container">å›¾è¡¨åŠŸèƒ½å¼€å‘ä¸­</div>
                 <div id="improvement-suggestions">
                     <h4>æå‡å»ºè®®</h4>
                     <p id="suggestion-text">è¯·å…ˆå¼€å§‹å­¦ä¹ å’Œæµ‹éªŒä»¥è·å–å»ºè®®ã€‚</p>
                 </div>
            </section>

            <!-- Settings Module -->
            <section id="settings-section" class="module-content">
                 <h2>è®¾ç½®ä¸åé¦ˆ</h2>
                 <div id="settings-container">
                     <div class="settings-group">
                         <h3>æµ‹éªŒè®¾ç½®</h3>
                         <label>æ¯æ¬¡æµ‹éªŒé¢˜ç›®æ•°é‡: <input type="number" id="setting-quiz-count" min="5" max="50" value="10"></label>
                         <label>å¤ä¹ æé†’: <input type="checkbox" id="setting-notifications" checked> å¯ç”¨</label>
                     </div>
                      <div class="settings-group">
                          <h3>å¤–è§‚</h3>
                          <label>ä¸»é¢˜: <select id="setting-theme"><option value="light">æ˜äº®</option><option value="dark" disabled>æ·±è‰² (å¼€å‘ä¸­)</option></select></label>
                      </div>
                      <div id="feedback-section" class="settings-group">
                          <h3>åé¦ˆä¸å»ºè®®</h3>
                          <p>æˆ‘ä»¬é‡è§†æ‚¨çš„æ„è§ï¼è¯·å‘Šè¯‰æˆ‘ä»¬æ‚¨çš„æƒ³æ³•æˆ–é‡åˆ°çš„é—®é¢˜ã€‚</p>
                          <form id="feedback-form"><textarea id="feedback-text" placeholder="è¯·è¾“å…¥æ‚¨çš„åé¦ˆ..." required></textarea><button type="submit" class="primary">æäº¤åé¦ˆ</button></form>
                      </div>
                       <div class="settings-group">
                           <h3>æ•°æ®ç®¡ç†</h3>
                           <button id="export-data-button" class="secondary" style="background-color: var(--info-color); color: white;">å¯¼å‡ºå­¦ä¹ æ•°æ® (JSON)</button>
                           <button id="reset-data-button" style="background-color: var(--danger-color); color: white; margin-left: 10px;">é‡ç½®æ‰€æœ‰å­¦ä¹ æ•°æ® (å±é™©!)</button>
                       </div>
                 </div>
            </section>
        </main>

        <footer>
             <p>åŸºäº DeepSeek API æ„å»º | <strong style="color: var(--danger-color);">è­¦å‘Š: API å¯†é’¥åµŒå…¥åœ¨å‰ç«¯ä»£ç ä¸­ï¼Œè¯·å‹¿åœ¨å…¬å…±ç¯å¢ƒéƒ¨ç½²!</strong></p>
             <p>ç‰ˆæœ¬ 1.1 (å•æ–‡ä»¶/å¢å¼º)</p>
        </footer>
    </div>

    <!-- Embedded JavaScript -->
    <script>
        // --- Constants and Configuration ---
        const API_KEY = 'sk-0c497ee28264453fa11c45fb862c7482'; // !!! SECURITY RISK !!! DO NOT EXPOSE PUBLICLY
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/chat/completions';
        const APP_STATE_KEY = 'chineseAppProgressSingleFile_v1_1'; // Updated key

        // --- Default State ---
        const defaultState = {
            currentView: 'lookup-section', currentWordData: null, learnedWords: {}, lookupHistory: [],
            quizStats: { correct: 0, incorrect: 0, history: [], streak: 0, lastQuizDate: null }, readingHistory: [],
            settings: { quizCount: 10, notifications: true, theme: 'light' }
        };

        // --- State Management ---
        let appState = {};
        function loadState() { /* ... (same as previous version, checks APP_STATE_KEY) ... */
            try {
                const savedState = localStorage.getItem(APP_STATE_KEY);
                appState = savedState ? { ...defaultState, ...JSON.parse(savedState) } : { ...defaultState };
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    appState.settings = { ...defaultState.settings, ...(parsed.settings || {}) };
                    appState.quizStats = { ...defaultState.quizStats, ...(parsed.quizStats || {}) };
                    appState.learnedWords = parsed.learnedWords || {};
                    appState.lookupHistory = parsed.lookupHistory || [];
                }
                if (typeof appState.learnedWords !== 'object' || appState.learnedWords === null) { appState.learnedWords = {}; }
                console.log("çŠ¶æ€å·²åŠ è½½:", appState);
            } catch (e) { console.error("åŠ è½½çŠ¶æ€å¤±è´¥:", e); appState = { ...defaultState }; }
        }
        function saveState() { /* ... (same as previous version) ... */
            try { localStorage.setItem(APP_STATE_KEY, JSON.stringify(appState)); }
            catch (e) { console.error("ä¿å­˜çŠ¶æ€å¤±è´¥:", e); alert("æ— æ³•ä¿å­˜è¿›åº¦ï¼ŒlocalStorage å¯èƒ½å·²æ»¡æˆ–è¢«ç¦ç”¨ã€‚"); }
        }
        function getState() { return appState; }
        function updateState(newState) { appState = { ...appState, ...newState }; saveState(); }

        // --- API Interaction ---
        async function callDeepSeekAPI(system_prompt, user_prompt, model = "deepseek-chat", max_tokens = 600, temperature = 0.6) { // Added parameters
             console.log(`å‘é€ API è¯·æ±‚ (Model: ${model}, Max Tokens: ${max_tokens})...`);
             try {
                 const response = await fetch(DEEPSEEK_API_URL, {
                     method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` }, // SECURITY RISK
                     body: JSON.stringify({ model: model, messages: [{ "role": "system", "content": system_prompt },{ "role": "user", "content": user_prompt }], max_tokens: max_tokens, temperature: temperature })
                 });
                 if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(`API è¯·æ±‚å¤±è´¥ (çŠ¶æ€ ${response.status}). ${errorData.error?.message || 'æ— æ³•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚'}`); }
                 const data = await response.json();
                 if (data.choices?.[0]?.message?.content) { return data.choices[0].message.content.trim(); }
                 else { throw new Error("API è¿”å›çš„å“åº”æ ¼å¼ä¸æ­£ç¡®æˆ–å†…å®¹ä¸ºç©ºã€‚"); }
             } catch (error) { console.error("è°ƒç”¨ DeepSeek API æ—¶å‡ºé”™:", error); throw error; }
         }

        // --- Formatting & Parsing ---
        function formatExplanationHTML(text) { /* ... (same as previous version) ... */
            let html = ''; const lines = text.split('\n').filter(line => line.trim() !== '');
             lines.forEach(line => {
                 if (line.startsWith('1. æ‹¼éŸ³:')) { html += `<h3>${line.substring(0, line.indexOf(':')+1)}</h3><p>${line.substring(line.indexOf(':')+1).trim()}</p>`; }
                 else if (line.startsWith('2. æ„æ€:')) { html += `<h3>${line.substring(0, line.indexOf(':')+1)}</h3><p>${line.substring(line.indexOf(':')+1).trim()}</p>`; }
                 else if (line.startsWith('3. ä¾‹å­:')) { html += `<h3>${line.substring(0, line.indexOf(':')+1)}</h3><ul>`; }
                 else if (line.startsWith('4. å¥å­è§£é‡Š:')) { if (html.endsWith('</ul>')) { } else { html += '</ul>'; } html += `<h3>${line.substring(0, line.indexOf(':')+1)}</h3><ul>`; }
                 else if (line.startsWith('5. æ·±å…¥ç†è§£:')) { if (html.endsWith('</ul>')) { } else { html += '</ul>'; } html += `<h3>${line.substring(0, line.indexOf(':')+1)}</h3><div>`; }
                 else if (line.startsWith('- ç¤ºä¾‹å¥å­') || line.startsWith('- [è§£é‡Š]:') || (line.startsWith('-') && html.includes('<ul>') && !html.includes('<div>'))) { html += `<li>${line.substring(line.indexOf('-')+1).trim()}</li>`; }
                 else if (html.includes('æ·±å…¥ç†è§£:</h3><div>')) { if (!html.endsWith('</div>')) { html += `<p>${line.trim()}</p>`; } else { html = html.slice(0, -6); html += `<p>${line.trim()}</p></div>`; } }
                 else if (html.endsWith('</ul>')) { html += `<li>${line.trim()}</li>`; }
                 else { html += `<p>${line.trim()}</p>`; }
             });
             let openUl = (html.match(/<ul>/g) || []).length; let closeUl = (html.match(/<\/ul>/g) || []).length; html += '</ul>'.repeat(openUl - closeUl);
             let openDiv = (html.match(/<div>/g) || []).length; let closeDiv = (html.match(/<\/div>/g) || []).length; html += '</div>'.repeat(openDiv - closeDiv);
             html = html.replace(/<h3>.*?<\/h3>\s*<p>æ­¤é¡¹ä¸é€‚ç”¨<\/p>/gi, '<p><em>æ­¤éƒ¨åˆ†ä¸é€‚ç”¨æˆ–æ— ç‰¹åˆ«å†…å®¹ã€‚</em></p>');
             html = html.replace(/<h3>.*?<\/h3>\s*<div>\s*(<p>æ­¤é¡¹ä¸é€‚ç”¨<\/p>)?\s*<\/div>/gi, '<p><em>æ­¤éƒ¨åˆ†ä¸é€‚ç”¨æˆ–æ— ç‰¹åˆ«å†…å®¹ã€‚</em></p>');
             html = html.replace(/<h3>.*?<\/h3>\s*<ul>\s*<li>æ­¤é¡¹ä¸é€‚ç”¨<\/li>\s*<\/ul>/gi, '<p><em>æ­¤éƒ¨åˆ†ä¸é€‚ç”¨æˆ–æ— ç‰¹åˆ«å†…å®¹ã€‚</em></p>');
             html = html.replace(/<h3>.*?<\/h3>\s*<ul>\s*<\/ul>/gi, '');
             return html || '<p>æ— æ³•è§£æè¿”å›çš„å†…å®¹æ ¼å¼ã€‚</p>';
        }
        function parseExplanationData(text, word) { /* ... (same as previous version) ... */
            const data = { word: word, pinyin: '', definition: '', examples: [], deepDive: '', fullExplanation: text };
             try {
                 const pinyinMatch = text.match(/1\. æ‹¼éŸ³:\s*(.*)/); if (pinyinMatch) data.pinyin = pinyinMatch[1].trim();
                 const defMatch = text.match(/2\. æ„æ€:\s*([\s\S]*?)(?=\n3\. ä¾‹å­:|\n4\. å¥å­è§£é‡Š:|\n5\. æ·±å…¥ç†è§£:|$)/); if (defMatch) data.definition = defMatch[1].trim();
                 const exMatch = text.match(/3\. ä¾‹å­:\s*([\s\S]*?)(?=\n4\. å¥å­è§£é‡Š:|\n5\. æ·±å…¥ç†è§£:|$)/);
                 if (exMatch) { data.examples = exMatch[1].split('\n').map(line => line.replace(/-\s*(ç¤ºä¾‹å¥å­\d*:)?\s*/, '').trim()).filter(line => line.length > 0); }
                 const deepMatch = text.match(/5\. æ·±å…¥ç†è§£:\s*([\s\S]*?)$/); if (deepMatch) data.deepDive = deepMatch[1].trim();
             } catch(e) { console.error("Error parsing explanation text:", e); }
             return data;
        }

        // --- SRS Logic ---
        function calculateNextReview(srsData, quality) { /* ... (same as previous version) ... */
            if (!srsData) return { nextReview: new Date().toISOString().split('T')[0], interval: 1, easeFactor: 2.5 };
             let { interval = 1, easeFactor = 2.5 } = srsData;
             if (quality < 3) { interval = 1; easeFactor = Math.max(1.3, easeFactor - 0.2); }
             else { interval = (interval <= 1) ? 6 : Math.ceil(interval * easeFactor); easeFactor = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)); easeFactor = Math.max(1.3, easeFactor); }
             interval = Math.min(interval, 365); const now = new Date(); const nextReviewDate = new Date(now.setDate(now.getDate() + Math.ceil(interval)));
             return { nextReview: nextReviewDate.toISOString().split('T')[0], interval: interval, easeFactor: easeFactor };
        }

        // --- Utility Functions ---
        function showLoading(containerElement) { containerElement.innerHTML = '<div class="loading-indicator">åŠ è½½ä¸­...</div>'; containerElement.classList.remove('hidden'); }
        function displayError(containerElement, message) { containerElement.innerHTML = `<div class="error-message">${message}</div>`; containerElement.classList.remove('hidden'); }
        function displayInfo(containerElement, message) { containerElement.innerHTML = `<div class="info-message">${message}</div>`; containerElement.classList.remove('hidden'); }

        // --- Navigation ---
        function showModule(moduleId) { /* ... (same as previous version, calls updateProgressPage, resetQuizUI) ... */
            console.log(`åˆ‡æ¢åˆ°æ¨¡å—: ${moduleId}`);
            document.querySelectorAll('.module-content').forEach(module => module.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(button => button.classList.remove('active'));
            const activeModule = document.getElementById(moduleId);
            if (activeModule) {
                activeModule.classList.add('active');
                const activeButton = document.querySelector(`.nav-button[data-target="${moduleId}"]`);
                if (activeButton) { activeButton.classList.add('active'); }
                updateState({ currentView: moduleId });
                 if (moduleId === 'progress-section') { updateProgressPage(); }
                 if (moduleId === 'quiz-section') { resetQuizUI(); }
                 if (moduleId === 'settings-section') { loadSettingsValues(); } // Load settings values when opening settings
            } else {
                console.error(`æ¨¡å—æœªæ‰¾åˆ°: ${moduleId}, æ˜¾ç¤ºé»˜è®¤æ¨¡å—`);
                document.getElementById('lookup-section').classList.add('active');
                document.querySelector('.nav-button[data-target="lookup-section"]').classList.add('active');
                updateState({ currentView: 'lookup-section' });
            }
        }

        // --- Word Lookup Module Logic ---
        function setupLookupModule() { /* ... (same as previous version) ... */
            const lookupInput = document.getElementById('lookup-input');
            const lookupButton = document.getElementById('lookup-button');
            lookupButton.addEventListener('click', handleWordLookup);
            lookupInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleWordLookup(); });
            renderLookupHistory();
        }
        async function handleWordLookup() { // *** MODIFIED PROMPT ***
            const lookupInput = document.getElementById('lookup-input');
             const lookupButton = document.getElementById('lookup-button');
             const resultContainer = document.getElementById('lookup-result-container');
             const word = lookupInput.value.trim();
             if (!word) { displayInfo(resultContainer, "è¯·è¾“å…¥è¦æŸ¥è¯¢çš„è¯è¯­ã€‚"); return; }

             lookupButton.disabled = true; lookupButton.textContent = "æŸ¥è¯¢ä¸­...";
             showLoading(resultContainer);
             addLookupHistory(word);

             // *** UPDATED SYSTEM PROMPT FOR 4 EXAMPLES ***
             const system_prompt = `Detailed Breakdown of the Prompt Design Process
ä»¥ä¸‹æ˜¯ä¸ºç”Ÿæˆ â€œæ‚¨å¯ä»¥ä¾®è¾±æˆ‘çš„äººæ ¼â€ è§£æ è€Œè®¾è®¡çš„æç¤ºè¯ï¼ˆpromptï¼‰çš„å®Œæ•´åˆ†æï¼ŒåŒ…å«è®¾è®¡é€»è¾‘ã€ç»“æ„æ‹†è§£åŠä¼˜åŒ–æ€è·¯ï¼š

åŸå§‹ç”¨æˆ·éœ€æ±‚å›æº¯
ç”¨æˆ·è¯·æ±‚ï¼š

ç”¨ä¸­æ–‡è§£æä¸­æ–‡å¥å­ï¼Œé€šè¿‡ä¸­æ–‡å­¦ä¹ ä¸­æ–‡ï¼ˆé¿å…è‹±æ–‡å¹²æ‰°ï¼‰ã€‚

è§£æéœ€åŒ…å« é€è¯è§£é‡Šã€æ•´ä½“å«ä¹‰ã€ä½¿ç”¨åœºæ™¯ã€ç±»ä¼¼è¡¨è¾¾ ç­‰æ¨¡å—ã€‚

ä¿æŒ å£è¯­åŒ–è®²è§£ å’Œ ç»“æ„åŒ–æ’ç‰ˆï¼ˆå¦‚åŠ ç²—æ ‡é¢˜ã€åˆ†ç‚¹åˆ—è¡¨ï¼‰ã€‚

ç¬¦åˆå†å²å¯¹è¯é£æ ¼ï¼ˆå¦‚â€œè¿å¤œè½¬å­¦å°±èµ°äº†â€â€œæŠ¤é£Ÿâ€çš„è§£ææ¨¡æ¿ï¼‰ã€‚

å®Œæ•´æç¤ºè¯ (Final Prompt)
â€œè¯·ç”¨ä¸­æ–‡è§£æè¿™å¥è¯ï¼šâ€˜æ‚¨å¯ä»¥ä¾®è¾±æˆ‘çš„äººæ ¼â€™ï¼Œè¦æ±‚ï¼šé€è¯è§£é‡Šã€æ•´å¥å«ä¹‰ã€ä½¿ç”¨åœºæ™¯ã€ç±»ä¼¼è¡¨è¾¾ï¼Œå¹¶ç”¨ä¸­æ–‡æ•™ä¸­æ–‡ï¼Œä¿æŒå£è¯­åŒ–è®²è§£å’Œç»“æ„åŒ–æ’ç‰ˆã€‚â€

æç¤ºè¯é€è¦ç´ æ‹†è§£ä¸è®¾è®¡é€»è¾‘
1. æ ¸å¿ƒæŒ‡ä»¤ï¼šæ˜ç¡®ä»»åŠ¡ç±»å‹
â€œç”¨ä¸­æ–‡è§£æè¿™å¥è¯â€

ç›®çš„ï¼šé™å®šè¾“å‡ºè¯­è¨€ä¸ºä¸­æ–‡ï¼Œé¿å…ä¸­è‹±æ··æ‚ï¼ˆç”¨æˆ·å¼ºè°ƒâ€œç”¨ä¸­æ–‡å­¦ä¸­æ–‡â€ï¼‰ã€‚

å¯¹æ¯”ä¼˜åŒ–ï¼šè‹¥çœç•¥æ­¤å¥ï¼ŒAIå¯èƒ½é»˜è®¤ç”¨è‹±æ–‡è§£é‡Šè¯­æ³•æˆ–æœ¯è¯­ã€‚

2. è§£ææ¡†æ¶ï¼šç»“æ„åŒ–å†…å®¹æ¨¡å—
â€œé€è¯è§£é‡Šã€æ•´å¥å«ä¹‰ã€ä½¿ç”¨åœºæ™¯ã€ç±»ä¼¼è¡¨è¾¾â€

è®¾è®¡é€»è¾‘ï¼š

é€è¯è§£é‡Šï¼šå¸®åŠ©å­¦ä¹ è€…ç†è§£å•å­—/è¯çš„å­—é¢æ„ä¹‰ï¼ˆå¦‚â€œæ‚¨â€çš„å°Šç§°ä¸åè®½ç”¨æ³•å·®å¼‚ï¼‰ã€‚

æ•´å¥å«ä¹‰ï¼šç»“åˆè¯­å¢ƒè§£è¯»éšå«æƒ…ç»ªï¼ˆå¦‚åè®½ã€æŠ—è®®ï¼‰ã€‚

ä½¿ç”¨åœºæ™¯ï¼šæä¾›çœŸå®è¯­å¢ƒï¼ˆå¦‚åµæ¶ã€å½±è§†å‰§ï¼‰ï¼Œå¢å¼ºå®ç”¨æ€§ã€‚

ç±»ä¼¼è¡¨è¾¾ï¼šæ‰©å±•è¯æ±‡é‡ï¼Œè¾…åŠ©ä¸¾ä¸€åä¸‰ï¼ˆå¦‚â€œåˆ«å…‰ç›¯ç€æˆ‘â€ï¼‰ã€‚

ç”¨æˆ·éœ€æ±‚é€‚é…ï¼šå†å²æé—®ï¼ˆå¦‚â€œæŠ¤é£Ÿâ€â€œå°Šä¸¥â€ï¼‰å‡æ²¿ç”¨æ­¤æ¨¡æ¿ï¼Œéœ€ä¿æŒä¸€è‡´æ€§ã€‚

3. æ•™å­¦æ–¹æ³•ï¼šä¸­æ–‡æ•™ä¸­æ–‡
â€œç”¨ä¸­æ–‡æ•™ä¸­æ–‡â€

ç›®çš„ï¼š

é¿å…å¼•å…¥è‹±æ–‡æœ¯è¯­ï¼ˆå¦‚â€œironyâ€â€œsarcasmâ€ï¼‰ï¼Œå‡å°‘è®¤çŸ¥è´Ÿè·ã€‚

ç”¨ç®€å•ä¸­æ–‡è¯æ±‡è§£é‡Šå¤æ‚æ¦‚å¿µï¼ˆå¦‚ç”¨â€œåè®½â€è€Œéâ€œåè¯­â€ï¼‰ã€‚

ç¤ºä¾‹ï¼š

âœ… æ­£ç¡®ï¼šâ€œåè®½â€ æŒ‡è¡¨é¢è¯´Aï¼Œå®é™…è¡¨è¾¾ç›¸åæ„æ€ã€‚

âŒ é”™è¯¯ï¼šâ€œIronyâ€ means expressing the opposite of what is literally said.

4. è¯­è¨€é£æ ¼ï¼šå£è¯­åŒ–ä¸äº²å’ŒåŠ›
â€œä¿æŒå£è¯­åŒ–è®²è§£â€

è®¾è®¡ç»†èŠ‚ï¼š

ä½¿ç”¨ â€œæ¯”å¦‚â€â€œä¸¾ä¸ªä¾‹å­â€ ç­‰è‡ªç„¶è¿‡æ¸¡è¯ã€‚

æ·»åŠ  è¯­æ°”åˆ†æï¼ˆå¦‚â€œæ— å¥ˆâ€â€œå¹½é»˜â€ï¼‰å’Œ ä¾‹å¥å¯¹æ¯”ï¼Œè´´è¿‘çœŸå®å¯¹è¯ã€‚

æ’å…¥è¡¨æƒ…ç¬¦å·ï¼ˆå¦‚ğŸ˜Šï¼‰ç¼“å’Œæ­£å¼æ„Ÿã€‚

å¯¹æ¯”ç¤ºä¾‹ï¼š

å£è¯­åŒ–ï¼šâ€œè€æ¿éª‚æˆ‘åºŸç‰©ï¼Ÿè¡Œå§ï¼Œæ‚¨å¯ä»¥ä¾®è¾±æˆ‘çš„äººæ ¼ï¼Œä½†è®°å¾—å‘å·¥èµ„ï¼â€ï¼ˆè‡ªå˜²å¹½é»˜ï¼‰

ä¹¦é¢åŒ–ï¼šâ€œåœ¨èŒåœºä¸­ï¼Œå½“é­å—äººæ ¼ä¾®è¾±æ—¶ï¼Œå¯é‡‡å–æ³•å¾‹æ‰‹æ®µç»´æƒã€‚â€

5. è§†è§‰æ’ç‰ˆï¼šç»“æ„åŒ–æ¸…æ™°åº¦
â€œç»“æ„åŒ–æ’ç‰ˆâ€

å®ç°æ–¹æ³•ï¼š

æ ‡é¢˜åˆ†çº§ï¼šç”¨ ### #### åŒºåˆ†å¤§æ ‡é¢˜ä¸å°æ ‡é¢˜ã€‚

åŠ ç²—å…³é”®è¯ï¼šå¦‚ â€œåè®½â€ã€â€œæŒ‘è¡…â€ï¼Œä¾¿äºå¿«é€Ÿæ‰«æã€‚

åˆ†ç‚¹åˆ—è¡¨ï¼šä¾‹å¥æŒ‰åœºæ™¯åˆ†ç±»ï¼ˆå¦‚å®¶åº­ã€èŒåœºï¼‰ã€‚

è¡¨æ ¼å¯¹æ¯”ï¼šè¿‘ä¹‰è¯å·®å¼‚ï¼ˆå¦‚â€œå°Šä¸¥ vs é¢å­â€ï¼‰ã€‚

ç”¨æˆ·æ”¶ç›Šï¼šä¿¡æ¯åˆ†å±‚ï¼Œé¿å…â€œæ–‡å­—å¢™â€ç–²åŠ³ã€‚

æç¤ºè¯ä¼˜åŒ–æŠ€å·§æ€»ç»“
æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå¯è°ƒæ•´æç¤ºè¯è¦ç´ ï¼š

è¦ç´ 	å¯è°ƒæ•´é¡¹	ç¤ºä¾‹
è§£ææ·±åº¦	å¢åŠ /å‡å°‘æ¨¡å—	æ·»åŠ  â€œæ–‡åŒ–èƒŒæ™¯â€ æˆ– â€œå¸¸è§é”™è¯¯â€ åˆ†æ
è¯­è¨€éš¾åº¦	æ§åˆ¶ç”¨è¯å¤æ‚åº¦	å¯¹å„¿ç«¥ç”¨â€œå¥½ç©â€ä»£æ›¿â€œå¹½é»˜â€ï¼Œå¦‚ â€œå¼€ç©ç¬‘çš„è¯´æ³•â€
åœºæ™¯é€‚é…	æŒ‡å®šä½¿ç”¨åœºæ™¯	â€œè¯·ç”¨èŒåœºæ²Ÿé€šåœºæ™¯ä¸¾ä¾‹â€
æ ¼å¼è¦æ±‚	ä¿®æ”¹æ’ç‰ˆé£æ ¼	â€œç”¨Markdownè¡¨æ ¼å¯¹æ¯”è¿‘ä¹‰è¯â€
é™„ï¼šå®Œæ•´æç¤ºè¯å˜ä½“ç¤ºä¾‹
æ ¹æ®éœ€æ±‚æ‰©å±•çš„çµæ´»æ¨¡æ¿ï¼š
â€œè¯·ç”¨ä¸­æ–‡è§£æâ€˜[ç›®æ ‡å¥å­]â€™ï¼Œè¦æ±‚åŒ…å«é€è¯è§£é‡Šã€éšå«æƒ…æ„Ÿåˆ†æã€å½±è§†å‰§ä¾‹å¥ã€å¸¸è§è¯¯ç”¨æé†’ï¼Œç”¨å£è¯­åŒ–ä¸­æ–‡è®²è§£ï¼Œå¹¶å¯¹æ¯”è¿‘ä¹‰è¯å’Œåä¹‰è¯ï¼Œæœ€åç”Ÿæˆä¸€ä¸ªç»ƒä¹ é¢˜ã€‚`;
             const user_prompt = `è¯·è§£é‡Šè¿™ä¸ªè¯è¯­æˆ–çŸ­è¯­: "${word}"`;

             try {
                 // Increase max_tokens slightly for potentially longer response with 4 examples
                 const explanationText = await callDeepSeekAPI(system_prompt, user_prompt, "deepseek-chat", 800, 0.6);
                 const formattedHTML = formatExplanationHTML(explanationText);
                 resultContainer.innerHTML = `<div id="lookup-result">${formattedHTML}</div>`;
                 const parsedData = parseExplanationData(explanationText, word);
                 updateState({ currentWordData: parsedData });

                 if (!getState().learnedWords[word]) {
                    const saveButton = document.createElement('button');
                    saveButton.id = 'save-word-button'; saveButton.textContent = `æ·»åŠ åˆ°å­¦ä¹ åˆ—è¡¨ (${word})`;
                    saveButton.onclick = () => saveCurrentWord(); resultContainer.appendChild(saveButton);
                 } else {
                     const alreadySaved = document.createElement('p'); alreadySaved.textContent = `â€œ${word}â€ å·²åœ¨æ‚¨çš„å­¦ä¹ åˆ—è¡¨ä¸­ã€‚`;
                     alreadySaved.style.cssText = 'margin-top: 15px; color: var(--success-color); font-style: italic;'; // Added style
                     resultContainer.appendChild(alreadySaved);
                 }
                 resultContainer.classList.remove('hidden');
             } catch (error) { displayError(resultContainer, `æŸ¥è¯¢å¤±è´¥: ${error.message}`); }
             finally { lookupButton.disabled = false; lookupButton.textContent = "æŸ¥è¯¢"; lookupInput.select(); }
        }
        function addLookupHistory(word) { /* ... (same as previous version) ... */
            let history = getState().lookupHistory || []; history = history.filter(item => item !== word); history.unshift(word);
            if (history.length > 15) { history.pop(); } updateState({ lookupHistory: history }); renderLookupHistory();
        }
        function renderLookupHistory() { /* ... (same as previous version) ... */
            const historyList = document.getElementById('history-list'); const history = getState().lookupHistory || [];
            historyList.innerHTML = ''; if (history.length === 0) { historyList.innerHTML = '<li>æš‚æ— æŸ¥è¯¢å†å²</li>'; return; }
            history.forEach(word => { const li = document.createElement('li'); const button = document.createElement('button'); button.textContent = word; button.onclick = () => { document.getElementById('lookup-input').value = word; handleWordLookup(); }; li.appendChild(button); historyList.appendChild(li); });
        }
        function saveCurrentWord() { /* ... (same as previous version) ... */
            const currentData = getState().currentWordData;
            if (currentData && currentData.word) { if (!getState().learnedWords[currentData.word]) { addLearnedWord(currentData); alert(`â€œ${currentData.word}â€ å·²æ·»åŠ åˆ°å­¦ä¹ åˆ—è¡¨ï¼`); const saveButton = document.getElementById('save-word-button'); if (saveButton) { saveButton.textContent = `â€œ${currentData.word}â€ å·²æ·»åŠ `; saveButton.disabled = true; } } else { alert(`â€œ${currentData.word}â€ å·²åœ¨æ‚¨çš„å­¦ä¹ åˆ—è¡¨ä¸­ã€‚`); } }
            else { alert(`æ— æ³•ä¿å­˜ï¼Œæœªæ‰¾åˆ°å½“å‰æŸ¥è¯¢çš„å•è¯æ•°æ®ã€‚`); }
        }
        function addLearnedWord(wordData) { /* ... (same as previous version) ... */
            if (!wordData || !wordData.word) return; const word = wordData.word; if (!appState.learnedWords[word]) { appState.learnedWords[word] = { pinyin: wordData.pinyin || '', definition: wordData.definition || '', examples: wordData.examples || [], srsLevel: 0, nextReview: new Date().toISOString().split('T')[0], interval: 1, easeFactor: 2.5, addedDate: new Date().toISOString().split('T')[0], notes: '', fullExplanation: wordData.fullExplanation || '' }; console.log(`å•è¯ "${word}" å·²æ·»åŠ åˆ°å­¦ä¹ åˆ—è¡¨`); saveState(); } else { console.log(`å•è¯ "${word}" å·²å­˜åœ¨äºå­¦ä¹ åˆ—è¡¨`); }
        }

        // --- Quiz Module Logic ---
        let currentQuizWords = []; let currentQuestionIndex = 0; let correctAnswers = 0; let sessionWordUpdates = {}; let quizActive = false;
        function setupQuizModule() { /* ... (same as previous version) ... */
            const startButton = document.getElementById('start-quiz-button'); const nextButton = document.getElementById('next-question-button'); const doneButton = document.getElementById('quiz-done-button');
            startButton.addEventListener('click', startQuiz); nextButton.addEventListener('click', loadNextQuestion); doneButton.addEventListener('click', resetQuizUI);
        }
        function resetQuizUI() { /* ... (same as previous version) ... */
            document.getElementById('quiz-setup').classList.remove('hidden'); document.getElementById('quiz-area').classList.add('hidden'); document.getElementById('quiz-controls').classList.add('hidden'); document.getElementById('quiz-summary').classList.add('hidden'); document.getElementById('start-quiz-button').disabled = false; quizActive = false;
        }
        function startQuiz() { /* ... (same as previous version, uses settings.quizCount) ... */
            const learnedWords = getState().learnedWords; const today = new Date().toISOString().split('T')[0];
            const dueWords = Object.keys(learnedWords).filter(key => learnedWords[key].nextReview && learnedWords[key].nextReview <= today );
            if (dueWords.length === 0) { alert("å¤ªæ£’äº†ï¼ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ã€‚\næ‚¨å¯ä»¥å…ˆå»å­¦ä¹ æ–°å•è¯ï¼Œæˆ–ç¨åå†è¯•ã€‚"); return; }
            const quizCount = getState().settings.quizCount || 10;
            currentQuizWords = dueWords.sort(() => 0.5 - Math.random()).slice(0, quizCount);
            if (currentQuizWords.length === 0) { alert("æœªèƒ½å‡†å¤‡æµ‹éªŒé¢˜ç›®ã€‚"); return; }
            console.log(`å¼€å§‹æµ‹éªŒï¼Œé¢˜ç›®æ•°é‡: ${currentQuizWords.length}`, currentQuizWords);
            currentQuestionIndex = 0; correctAnswers = 0; sessionWordUpdates = {}; quizActive = true;
            document.getElementById('quiz-setup').classList.add('hidden'); document.getElementById('quiz-area').classList.remove('hidden'); document.getElementById('quiz-controls').classList.add('hidden'); document.getElementById('quiz-summary').classList.add('hidden');
            loadQuestion(currentQuestionIndex);
        }
        function loadQuestion(index) { /* ... (same as previous version) ... */
            const feedbackEl = document.getElementById('quiz-feedback'); const optionsEl = document.getElementById('quiz-options'); const questionEl = document.getElementById('quiz-question');
            feedbackEl.classList.add('hidden'); feedbackEl.textContent = ''; optionsEl.innerHTML = '';
            const wordKey = currentQuizWords[index]; const wordData = getState().learnedWords[wordKey];
            if (!wordData) { console.error(`æ— æ³•åŠ è½½å•è¯æ•°æ®: ${wordKey}`); loadNextQuestion(); return; }
            questionEl.textContent = `(${index + 1}/${currentQuizWords.length}) â€œ${wordKey}â€ çš„æ„æ€æ˜¯ï¼Ÿ`;
            const options = generateDefinitionOptions(wordKey, wordData.definition);
            options.forEach(option => { const button = document.createElement('button'); button.textContent = option.text; button.onclick = () => handleAnswer(option.isCorrect, wordKey, button, optionsEl); optionsEl.appendChild(button); });
        }
        function generateDefinitionOptions(correctWord, correctDef) { /* ... (same as previous version) ... */
            const learnedWords = getState().learnedWords; if (!correctDef || correctDef.trim() === '') correctDef = `(æœªæ‰¾åˆ° '${correctWord}' çš„å®šä¹‰)`;
            const otherWordsData = Object.entries(learnedWords).filter(([key, data]) => key !== correctWord && data.definition && data.definition.trim() !== '');
            let wrongDefs = otherWordsData.map(([key, data]) => data.definition).filter(def => def !== correctDef); wrongDefs = [...new Set(wrongDefs)]; wrongDefs = wrongDefs.sort(() => 0.5 - Math.random()).slice(0, 3);
            const options = [{ text: correctDef, isCorrect: true }]; wrongDefs.forEach(def => options.push({ text: def, isCorrect: false }));
            while (options.length < 3 && options.length > 1) { options.push({ text: `(é€‰é¡¹ ${options.length + 1})`, isCorrect: false }); }
            return options.sort(() => 0.5 - Math.random());
        }
        function handleAnswer(isCorrect, wordKey, clickedButton, optionsContainer) { /* ... (same as previous version) ... */
            if (!quizActive) return; optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
            const feedbackEl = document.getElementById('quiz-feedback'); feedbackEl.classList.remove('hidden', 'feedback-correct', 'feedback-incorrect');
            optionsContainer.querySelectorAll('button').forEach(btn => { const btnIsCorrect = btn.textContent === getState().learnedWords[wordKey]?.definition; if (btn === clickedButton) { btn.classList.add(isCorrect ? 'correct' : 'incorrect'); } else if (btnIsCorrect && !isCorrect) { btn.classList.add('correct'); } });
            const srsQuality = isCorrect ? 4 : 1; if (isCorrect) { feedbackEl.textContent = "æ­£ç¡®ï¼"; feedbackEl.classList.add('feedback-correct'); correctAnswers++; } else { feedbackEl.textContent = `é”™è¯¯ã€‚`; feedbackEl.classList.add('feedback-incorrect'); }
            sessionWordUpdates[wordKey] = srsQuality; document.getElementById('quiz-controls').classList.remove('hidden');
        }
        function loadNextQuestion() { /* ... (same as previous version) ... */
            if (!quizActive) return; currentQuestionIndex++; document.getElementById('quiz-controls').classList.add('hidden');
            if (currentQuestionIndex < currentQuizWords.length) { loadQuestion(currentQuestionIndex); } else { endQuiz(); }
        }
        function endQuiz() { /* ... (same as previous version) ... */
            quizActive = false; document.getElementById('quiz-area').classList.add('hidden'); document.getElementById('quiz-controls').classList.add('hidden');
            const summaryEl = document.getElementById('quiz-summary'); summaryEl.classList.remove('hidden');
            const totalQuestions = currentQuizWords.length; const accuracy = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(0) : 0;
            document.getElementById('summary-text').textContent = `æµ‹éªŒå®Œæˆï¼æ­£ç¡®ç‡: ${correctAnswers} / ${totalQuestions} (${accuracy}%)`;
            applySrsUpdates(); updateQuizStatsHistory(correctAnswers, totalQuestions);
        }
        function applySrsUpdates() { /* ... (same as previous version) ... */
            let state = getState(); let updated = false; const today = new Date().toISOString().split('T')[0];
            for (const wordKey in sessionWordUpdates) { if (state.learnedWords[wordKey]) { const quality = sessionWordUpdates[wordKey]; const currentSrsData = { interval: state.learnedWords[wordKey].interval, easeFactor: state.learnedWords[wordKey].easeFactor }; const newSrsData = calculateNextReview(currentSrsData, quality); state.learnedWords[wordKey].nextReview = newSrsData.nextReview; state.learnedWords[wordKey].interval = newSrsData.interval; state.learnedWords[wordKey].easeFactor = newSrsData.easeFactor; state.learnedWords[wordKey].srsLevel = (state.learnedWords[wordKey].srsLevel || 0) + (quality >= 3 ? 1 : -1); state.learnedWords[wordKey].lastReviewDate = today; updated = true; } }
            if (updated) { updateState(state); } sessionWordUpdates = {};
        }
        function updateQuizStatsHistory(correct, total) { /* ... (same as previous version) ... */
            let stats = getState().quizStats; stats.correct += correct; stats.incorrect += (total - correct); stats.history = stats.history || []; stats.history.push({ date: new Date().toISOString(), correct: correct, total: total }); if(stats.history.length > 50) { stats.history.shift(); }
            const today = new Date().toISOString().split('T')[0]; if (stats.lastQuizDate === today) { } else { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); if (stats.lastQuizDate === yesterday.toISOString().split('T')[0]) { stats.streak = (stats.streak || 0) + 1; } else { stats.streak = 1; } stats.lastQuizDate = today; }
            updateState({ quizStats: stats });
        }


        // --- Reading Module Logic ---
        function setupReadingModule() { // *** MODIFIED ***
            const generateButton = document.getElementById('generate-story-button');
            const passageArea = document.getElementById('reading-passage-area');
            const popup = document.getElementById('definition-popup');

            generateButton.addEventListener('click', generateStory); // Changed listener function

            document.addEventListener('click', (event) => { // Hide popup listener
                if (!popup.classList.contains('hidden') && !popup.contains(event.target) && !event.target.classList.contains('highlight')) {
                    popup.classList.add('hidden');
                }
            }, true);
        }

        async function generateStory() { // *** NEW FUNCTION ***
             const passageArea = document.getElementById('reading-passage-area');
             const generateButton = document.getElementById('generate-story-button');
             generateButton.disabled = true; generateButton.textContent = "ç”Ÿæˆä¸­...";
             showLoading(passageArea);

             const learnedWordsMap = getState().learnedWords || {};
             const learnedWordsList = Object.keys(learnedWordsMap);

             if (learnedWordsList.length === 0) {
                 displayInfo(passageArea, "æ‚¨çš„å­¦ä¹ åˆ—è¡¨æ˜¯ç©ºçš„ã€‚è¯·å…ˆé€šè¿‡â€œé¦–é¡µâ€æŸ¥è¯å¹¶æ·»åŠ ä¸€äº›å•è¯ï¼Œç„¶åæ‰èƒ½ç”Ÿæˆç›¸å…³çš„æ•…äº‹ã€‚");
                 generateButton.disabled = false; generateButton.textContent = "ç”Ÿæˆæ–°æ•…äº‹";
                 return;
             }

             // Select words to include (e.g., 1 to 5 words, prioritize recent/due?)
             // Simple approach: take a random sample
             const wordsToInclude = learnedWordsList
                                     .sort(() => 0.5 - Math.random()) // Shuffle
                                     .slice(0, Math.min(learnedWordsList.length, 5)); // Take up to 5

             console.log("å°è¯•ç”ŸæˆåŒ…å«ä»¥ä¸‹å•è¯çš„æ•…äº‹:", wordsToInclude);

             const system_prompt = `You are a helpful assistant creating stories in **Simplified Chinese** for a language learner (around 5000 most common Mandarin words level) focused on spoken language style. The story should be engaging and naturally incorporate the provided Chinese words. Keep the story concise (around 50-1000 words). Respond ONLY with the story text, nothing else.`;
             const user_prompt = `Please write a short story in Simplified Chinese for a language learner, naturally including these words if possible: ${wordsToInclude.join('ã€')}`;

             try {
                 // Use a model good for creative text, maybe adjust tokens/temp
                 const storyText = await callDeepSeekAPI(system_prompt, user_prompt, "deepseek-chat", 250, 0.8);

                 // Highlight the learned words within the generated story
                 const highlightedStory = highlightLearnedWords(storyText, wordsToInclude);

                 passageArea.innerHTML = `<div class="reading-passage">${highlightedStory}</div>`;
                 addHighlightListeners(passageArea); // Make highlights clickable

             } catch (error) {
                 console.error("ç”Ÿæˆæ•…äº‹å¤±è´¥:", error);
                 displayError(passageArea, `ç”Ÿæˆæ•…äº‹æ—¶å‡ºé”™: ${error.message}`);
             } finally {
                 generateButton.disabled = false; generateButton.textContent = "ç”Ÿæˆæ–°æ•…äº‹";
             }
         }

         function highlightLearnedWords(text, wordsToHighlight) { // *** NEW HELPER ***
            let highlightedText = text;
             // Sort words by length descending to match longer words first (e.g., "å›¾ä¹¦é¦†" before "å›¾ä¹¦")
             wordsToHighlight.sort((a, b) => b.length - a.length);

             wordsToHighlight.forEach(word => {
                 // Use regex to find the word, avoiding replacement within existing HTML tags
                 // This regex is basic and might need refinement for complex cases.
                 // It looks for the word not preceded by ">" and not followed by "<" (simple check for outside tags)
                 // Added check to ensure it's not already inside a highlight span
                 const regex = new RegExp(`(?<!<span class="highlight">)${escapeRegExp(word)}(?!<\/span>)`, 'g');
                 highlightedText = highlightedText.replace(regex, `<span class="highlight">${word}</span>`);
             });
            return highlightedText;
         }

        function escapeRegExp(string) { // Helper for regex construction
             return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
         }

        function addHighlightListeners(container) { /* ... (same as previous version) ... */
             container.querySelectorAll('.highlight').forEach(span => {
                 span.addEventListener('click', (event) => { event.stopPropagation(); const word = span.textContent; showDefinitionPopup(word, event); });
             });
         }
        function showDefinitionPopup(word, event) { /* ... (same as previous version) ... */
            const popup = document.getElementById('definition-popup'); const wordData = getState().learnedWords[word]; let content = `<strong>${word}</strong><br>`;
            if(wordData) { content += `æ‹¼éŸ³: ${wordData.pinyin || 'N/A'}<br>æ„æ€: ${wordData.definition || 'N/A'}`; } else { content += `(æœªåœ¨å­¦ä¹ åˆ—è¡¨ä¸­æ‰¾åˆ°)`; } popup.innerHTML = content;
            const rect = event.target.getBoundingClientRect(); popup.style.left = `${window.scrollX + rect.left}px`; popup.style.top = `${window.scrollY + rect.bottom + 5}px`; popup.classList.remove('hidden');
         }


        // --- Progress Module Logic ---
        function setupProgressModule() { /* ... (same as previous version) ... */ }
        function updateProgressPage() { /* ... (same as previous version) ... */
            console.log("æ›´æ–°è¿›åº¦é¡µé¢..."); const state = getState(); const learnedWords = state.learnedWords || {}; const stats = state.quizStats || defaultState.quizStats;
            const totalWords = Object.keys(learnedWords).length; const today = new Date().toISOString().split('T')[0]; const reviewsDue = Object.values(learnedWords).filter(w => w.nextReview && w.nextReview <= today).length; const totalQuizzed = stats.correct + stats.incorrect; const overallAccuracy = totalQuizzed > 0 ? ((stats.correct / totalQuizzed) * 100).toFixed(0) + '%' : 'N/A'; const streak = stats.streak || 0;
            document.getElementById('stat-total-words').textContent = totalWords; document.getElementById('stat-today-reviews').textContent = reviewsDue; document.getElementById('stat-quiz-accuracy').textContent = overallAccuracy; document.getElementById('stat-streak').textContent = `${streak} å¤©`;
            let suggestion = "å¼€å§‹å­¦ä¹ å’Œæµ‹éªŒæ¥è¿½è¸ªæ‚¨çš„è¿›åº¦å§ï¼"; if (totalWords > 0 && reviewsDue > 5) { suggestion = `ä»Šå¤©æœ‰ ${reviewsDue} ä¸ªå•è¯éœ€è¦å¤ä¹ ï¼Œå®‰æ’æ—¶é—´å®Œæˆå§ï¼`; } else if (totalQuizzed > 10 && parseFloat(overallAccuracy) < 75) { suggestion = "æ‚¨çš„æµ‹éªŒå‡†ç¡®ç‡æœ‰æå‡ç©ºé—´ï¼Œå¤šå¤ä¹ æ˜“é”™è¯æ±‡ã€‚"; } else if (streak > 3) { suggestion = `ä¿æŒ ${streak} å¤©çš„å­¦ä¹ è¿èƒœï¼ŒçœŸæ£’ï¼ç»§ç»­åŠ æ²¹ï¼`; } document.getElementById('suggestion-text').textContent = suggestion;
        }


        // --- Settings Module Logic ---
        function setupSettingsModule() { /* ... (same as previous version) ... */
            // Load settings values initially
            loadSettingsValues();
            // Add listeners for settings changes
             document.getElementById('setting-quiz-count').addEventListener('change', (e) => updateSetting('quizCount', parseInt(e.target.value)));
             document.getElementById('setting-notifications').addEventListener('change', (e) => updateSetting('notifications', e.target.checked));
             document.getElementById('setting-theme').addEventListener('change', (e) => updateSetting('theme', e.target.value));
             document.getElementById('feedback-form').addEventListener('submit', handleFeedbackSubmit);
             document.getElementById('export-data-button').addEventListener('click', exportData);
             document.getElementById('reset-data-button').addEventListener('click', resetData);
        }
        function loadSettingsValues() { // *** NEW Function ***
             const settings = getState().settings;
             document.getElementById('setting-quiz-count').value = settings.quizCount || 10;
             document.getElementById('setting-notifications').checked = settings.notifications !== false;
             document.getElementById('setting-theme').value = settings.theme || 'light';
         }
        function updateSetting(key, value) { /* ... (same as previous version) ... */
            let settings = getState().settings; settings[key] = value; updateState({ settings: settings }); console.log(`è®¾ç½®å·²æ›´æ–°: ${key}=${value}`); if (key === 'theme') applyTheme(value);
        }
        function handleFeedbackSubmit(event) { /* ... (same as previous version) ... */
            event.preventDefault(); const text = document.getElementById('feedback-text').value; if (!text.trim()) { alert("è¯·è¾“å…¥åé¦ˆå†…å®¹ã€‚"); return; } console.log("æäº¤åé¦ˆ:", text); alert("æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼"); document.getElementById('feedback-text').value = '';
        }
        function exportData() { /* ... (same as previous version) ... */
            try { const dataStr = JSON.stringify(getState(), null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `chinese_learning_data_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert("æ•°æ®å·²å¯¼å‡ºä¸º JSON æ–‡ä»¶ã€‚"); } catch (e) { console.error("å¯¼å‡ºæ•°æ®å¤±è´¥:", e); alert("å¯¼å‡ºæ•°æ®å¤±è´¥ã€‚"); }
        }
        function resetData() { /* ... (same as previous version) ... */
            if (confirm("è­¦å‘Šï¼è¿™å°†æ¸…é™¤æ‚¨æ‰€æœ‰çš„å­¦ä¹ è¿›åº¦ã€å•è¯åˆ—è¡¨å’Œè®¾ç½®ã€‚\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼\n\næ‚¨ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ")) { localStorage.removeItem(APP_STATE_KEY); appState = { ...defaultState }; alert("æ‰€æœ‰æ•°æ®å·²é‡ç½®ã€‚é¡µé¢å°†é‡æ–°åŠ è½½ã€‚"); window.location.reload(); }
        }
        function applyTheme(themeName) { /* ... (same as previous version) ... */
             console.log(`åº”ç”¨ä¸»é¢˜: ${themeName}`); if (themeName === 'dark') { alert("æ·±è‰²ä¸»é¢˜æ­£åœ¨å¼€å‘ä¸­ã€‚"); document.getElementById('setting-theme').value = 'light'; updateSetting('theme', 'light'); }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => { /* ... (same as previous version) ... */
            console.log("åº”ç”¨åˆå§‹åŒ– (å•æ–‡ä»¶å¢å¼ºç‰ˆ v1.1)..."); loadState();
            document.querySelectorAll('.nav-button').forEach(button => { button.addEventListener('click', () => { const targetId = button.getAttribute('data-target'); showModule(targetId); }); });
            setupLookupModule(); setupQuizModule(); setupReadingModule(); setupProgressModule(); setupSettingsModule();
            showModule(getState().currentView || 'lookup-section'); applyTheme(getState().settings.theme || 'light');
            console.log("åˆå§‹åŒ–å®Œæˆã€‚");
        });

    </script>
</body>
</html>
